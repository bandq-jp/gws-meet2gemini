# セッション変更履歴 (2026-02)

> このファイルは必要時に `@docs/session-history/2026-02.md` で参照してください。

## 1. マーケティングAI SSEキープアライブ実装 (2026-02-01)

**問題**: 推論量が多い場合 (reasoning_effort: high/xhigh)、`stream_agent_response()` がトークン出力開始まで30秒〜数分沈黙 → Cloud Run / Vercel / ブラウザがSSEタイムアウト

**調査結果**:
- ChatKit SDK (Python v1.6.0, Frontend v1.5.0): キープアライブ機能なし
- OpenAI Agents SDK (v0.7.0): キープアライブ機能なし
- OpenAI Responses API: SSEハートビートを送信しない
- `reasoning.summary="detailed"` で推論中にイベントは流れるが、初期遅延が問題

**実装**:
- **新規**: `backend/app/infrastructure/chatkit/keepalive.py`
  - `with_keepalive(events, interval=20)` async generator
  - pump task + asyncio.Queue + wait_for(timeout) パターン
  - `_DoneSentinel` / `_ExceptionSentinel` で完了/例外を伝搬
  - `finally` で pump task を確実にキャンセル

- **変更**: `backend/app/infrastructure/chatkit/marketing_server.py`
  - メイン・フォールバック両ストリームを `with_keepalive()` でラップ

- **変更**: `backend/app/infrastructure/chatkit/tool_events.py`
  - `ToolUsageTracker` に `_bg_tasks` + `_fire_and_forget()` 追加
  - DB書き込み (`_save_tool_call_as_context`, `_save_tool_output_as_context`) を非同期化
  - `close()` で未完了タスクを10秒タイムアウトで待機

- **変更**: `frontend/src/app/marketing/page.tsx`
  - カスタム経過時間UIを追加後、ユーザーの指摘により**完全削除** → ChatKitネイティブ推論表示に委ねる

## 2. SDKバージョンアップ (2026-02-01)

- Backend: chatkit 1.5.3→1.6.0, agents 0.6.9→0.7.0, openai 2.15.0→2.16.0
- Frontend: chatkit 1.4.0→1.5.0, chatkit-react 1.4.2→1.4.3
- 破壊的変更なし（調査済み）

## 3. Supabaseエグレス削減 (2026-02-02)

**問題**: PostgRESTエグレスが908MB/日 (100%)、月間21.32GB でFree Plan (5GB) を大幅超過

**原因分析**:
- `collect-task` が30分〜2時間毎に実行され、全ドキュメントに対して `get_by_doc_and_organizer()` で `select("*")` (text_content含む) を毎回取得
- 変更チェックには `metadata.modifiedTime` しか不要なのに、5-50KB/件の text_content を毎回返却
- `upsert_meeting()`, `upsert_structured()`, `update_zoho_sync_status()` が返却値を使わないのに全カラムをレスポンスで受信
- ChatKit `load_threads()` で N+1 問題（スレッド一覧取得後、各スレッドを個別に再取得）

**修正内容**:
- **`meeting_repository_impl.py`**: `select("id,metadata")` に変更、`returning="minimal"` 追加
- **`structured_repository_impl.py`**: `returning="minimal"` 追加
- **`ai_usage_repository_impl.py`**: `returning="minimal"` 追加
- **`supabase_store.py`**: N+1解消、`returning="minimal"` 追加

**技術的知見**:
- supabase-py の `returning="minimal"` で PostgREST が `Prefer: return=minimal` を送信
- `ReturnMethod` enum は `postgrest.types` に定義

**期待効果**: 908MB/日 → ~50-100MB/日

## 4. Zoho CRM 日付フィルタリングバグ修正 (2026-02-03)

**問題**: 日付フィルタ（date_from/date_to）を指定すると0件が返る

**調査結果**:
- Zoho CRM Search API は、カスタムモジュール（jobSeeker）で日付/日時フィールドの比較演算子をサポートしていない
- `equals` 演算子のみ動作

**修正内容** (`backend/app/infrastructure/zoho/client.py`):
- `_fetch_all_records()`: Records APIで全件取得（ページング対応）
- `_filter_by_date()`: `field18`（登録日）でクライアントサイドフィルタリング
- 集計系メソッドは1回だけ全件取得し、メモリ内でフィルタ・集計

**効果**: 最適化前 ~255秒 → 最適化後 ~12秒 (約20倍高速化)

## 5. Zoho CRM COQL最適化 & 新規マーケティングツール追加 (2026-02-03)

**背景**: OAuthスコープ拡張（`ZohoCRM.coql.READ`追加）

**COQL最適化結果**:
| メソッド | 最適化前 | 最適化後 | 改善倍率 |
|----------|----------|----------|---------|
| `search_by_criteria` | ~25秒 | 0.52秒 | 48倍 |
| `count_by_channel` | ~23秒 | 0.21秒 | 110倍 |
| `count_by_status` | ~26秒 | 0.25秒 | 104倍 |

**Zoho COQL制限事項**:
- WHERE句が必須（`WHERE id is not null` で回避）
- LIKE演算子非サポート
- フィールドタイプ混合でエラー

**新規マーケティングツール** (`zoho_crm_tools.py`):
- `analyze_funnel_by_channel`, `trend_analysis_by_period`, `compare_channels`, `get_pic_performance`

## 6. 候補者インサイトツール追加 (2026-02-03)

**新規ツールモジュール** (`candidate_insight_tools.py`):
- `analyze_competitor_risk`: 競合エージェント分析
- `assess_candidate_urgency`: 緊急度評価
- `analyze_transfer_patterns`: 転職パターン分析
- `generate_candidate_briefing`: 候補者ブリーフィング

## 7. ローカルMCP移行実装 (2026-02-04)

**問題**: MCPサーバー接続で15-30秒の遅延

**解決策**: GA4/GSC/Meta AdsをローカルSTDIO実行に移行

**新規ファイル**:
- `backend/app/infrastructure/chatkit/mcp_manager.py`: MCPサーバーライフサイクル管理
- `backend/scripts/gsc_server.py`: GSC MCPサーバー（FastMCPベース）

**新規環境変数**:
```bash
USE_LOCAL_MCP=true
LOCAL_MCP_GA4_ENABLED=true
LOCAL_MCP_GSC_ENABLED=true
LOCAL_MCP_META_ADS_ENABLED=true
META_ACCESS_TOKEN=
```

**効果**: MCP初期化時間 15-30秒 → 1-2秒

## 8. Vercel SSEタイムアウト修正 (2026-02-04)

**問題**: 3-5分以上経過すると画面更新が停止

**修正内容**:
- `frontend/src/app/api/marketing/chatkit/server/route.ts`: `maxDuration = 300` 追加
- `X-Accel-Buffering: no` ヘッダー追加

## 9. ローカルMCPログ最適化 (2026-02-04)

装飾的区切り線削除、絵文字をプレーンテキストに変更

## 10. Meta Ads MCPフォールバックバグ修正 (2026-02-04)

`META_ACCESS_TOKEN`未設定時にホステッド版にフォールバックするよう修正

## 11. マーケティングエージェントトークン最適化 (2026-02-04)

**最適化結果**:
| 指標 | Before | After | 削減率 |
|------|--------|-------|--------|
| MCP許可ツール数 | 149 | 97 | 35% |
| システム指示文字数 | ~5,100 | 809 | 84% |
| 推定フル入力トークン | ~32,000 | ~8,000 | 75% |
